<?phpnamespace Home\Controller;class DuobaoController extends HomeController{	public function index()	{        $data = M("lotteryConfig")->Order('sort')->select();        $list = M("lotteryLog")->where(array('type'=>array('neq','empty')))->select();        foreach ($list as $k =>$v){            $list[$k]['username']=substr_replace(M('User')->where(array('id'=>$v['userid']))->getField('username'), '***', 3, 4);        }        $this->assign('data',$data);        $this->assign('list',$list);		$this->display();	}	public function time(){        $time=M('lotteryLog')->where(array('userid'=>userid()))->order('addtime desc')->find();        if(date('Y-m-d', $time['addtime'])===date('Y-m-d', time())){            $arr['status']=0;            $arr['info']='每天只能抽取一次';        }else{            $arr['status']=1;            $arr['info']='当天未抽取';        }        echo json_encode($arr);    }    public function duobao($ajax='json')    {        M()->startTrans();        $config=M('Config')->where(array('id'=>1))->find();        if($config['lottery_mum']<=$config['lottery_deal']){            $re[] = M("lotteryConfig")->where(array('type'=>'gold'))->save(array('status'=>0));        }        $user=M('User')->where(array('id'=>userid()))->find();        $data = M("lotteryConfig")->where(array('status'=>1))->select();        $arr=get_rand($data);        $map['userid']=userid();        $map['num']=$arr['num'];        $map['type']=$arr['type'];        $map['name']=$arr['name'];        $map['addtime']=time();        $re[]=M('lotteryLog')->add($map);        if($arr['type']!='empty'){            //增加已使用            $re[]=M('lotteryMax')->where(array('name'=>$arr['type']))->setInc('deal',$arr['num']);            if($arr['type']=='gold'){                $re[]=M('Config')->where(array('id'=>1))->setInc('lottery_deal',$arr['num']);            }            //发行用完禁用奖品            $max=M('lotteryMax')->select();            foreach ($max as $k=>$v){                    if($v['mum']<=$v['deal']){                        $re[] = M("lotteryConfig")->where(array('type'=>$v['name']))->save(array('status'=>0));                    }            }            if($arr['type']=='red'){                $arr['type']='zc';            }            $coin=$arr['type'];            $user_old_money=M("UserCoin")->where(array('userid'=>userid()))->find();            $re[] =$finance_nameid= M('invit')->add(array('userid' => userid(), 'name' => '抽奖', 'type' =>$coin,  'fee' => $arr['num'], 'addtime' => time(), 'status' => 1));            $re[] =M('UserCoin')->where(array('userid'=>userid()))->setInc($coin,$arr['num']);            $user_new_money=M("UserCoin")->where(array('userid'=>userid()))->find();           $re[] = M('finance')->add(array('userid' =>userid(), 'coinname' =>$coin , 'num_a' => $user_old_money[$coin], 'num_b' => $user_new_money[$coin.'d'], 'num' => $user_old_money[$coin] + $user_new_money[$coin.'d'], 'fee' => $arr['num'], 'type' => 1, 'name' => 'game', 'nameid' => $finance_nameid, 'remark' => '抽奖', 'mum_a' => $user_new_money[$coin], 'mum_b' => $user_new_money[$coin.'d'], 'mum' => $user_new_money[$coin] + $user_new_money[$coin.'d'], 'move' => md5($arr['num']), 'addtime' => time(), 'status' => 1));        }        if($re){            M()->commit();            if ($ajax) {                exit(json_encode($arr));            }            else {                return $arr;            }        }else{            M()->rollback();        }    }    }?>